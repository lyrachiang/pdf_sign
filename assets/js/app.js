$((function(){const e=new fabric.Canvas("pdfUploadCanvas"),t=$("#signCanvas")[0];let n=null,o=!1,a=null,i=null;function l(e,t){$(".toast").find(".toast-body").text(t).end().addClass("show"),"error"===e&&$(".toast").addClass("error"),setTimeout((()=>{$(".toast").find(".toast-body").text("").end().removeClass("error").removeClass("show")}),3e3)}function s(){const e=window.localStorage.getItem("signImg");if($(".sign_card_box").find("div").html(""),e){const t=JSON.parse(e),n='\n        <div class="sign_card" data-idx="{0}">\n          <a class="ico_box"><span></span></a>\n          <img src="{1}" alt="sign_img" />\n        </div>\n      ';t.forEach(((e,t)=>{$(".sign_card_box > div").append(n.format(t,e))})),t.length?$(".sign_container").find(".sign_box").removeClass("no_sign"):$(".sign_container").find(".sign_box").addClass("no_sign")}else $(".sign_container").find(".sign_box").addClass("no_sign")}function d(){o=!0,$("#btnSaveSign").removeClass("disabled").attr("disabled",!1)}function c(){o=!1,n.beginPath()}function r(e){if(!o)return;let a;const i=t.getBoundingClientRect();a="mousemove"===e.type?{x:e.clientX-i.left,y:e.clientY-i.top}:{x:e.touches[0].clientX-i.left,y:e.touches[0].clientY-i.top},n.lineTo(a.x,a.y),n.stroke()}async function g(e){var t;e=await(t=e,new Promise(((e,n)=>{const o=new FileReader;o.addEventListener("load",(()=>e(o.result))),o.addEventListener("error",n),o.readAsDataURL(t)})));const n=atob(e.substring("data:application/pdf;base64,".length)),o=await pdfjsLib.getDocument({data:n}).promise,a=await o.getPage(1),i=a.getViewport({scale:window.devicePixelRatio}),l=document.createElement("canvas"),s=l.getContext("2d");l.height=i.height,l.width=i.width;const d={canvasContext:s,viewport:i};return $("#uploadFilePage").text(`${o._pdfInfo.numPages}頁`),a.render(d).promise.then((()=>l))}async function p(t){const n=t.name,o=Math.floor(.001*t.size),a=n.substr(0,n.length-4);if(o>20971520)return void l("error","檔案大小超過20MB");e.requestRenderAll();const i=await g(t),s=await async function(e){const t=1/window.devicePixelRatio;return new fabric.Image(e,{id:"pdfImg",scaleX:t,scaleY:t})}(i);e.setWidth(s.width/window.devicePixelRatio),e.setHeight(s.height/window.devicePixelRatio),e.setBackgroundImage(s,e.renderAll.bind(e));const d=e.toDataURL("image/png");window.localStorage.setItem("uploadPdf",d),e.setWidth(242),e.setHeight(342),e.setBackgroundImage(s,e.renderAll.bind(e),{scaleX:e.width/s.width,scaleY:e.height/s.height}),$(".upload_block").hide(),$("#uploadFileName").text(n),$("#inputProjectName").val(a),$(".upload_edit_block").css("display","flex"),$("#btnNext").removeClass("disabled").attr("disabled",!1),l("info","檔案上傳成功"),window.localStorage.setItem("projectName",a)}t&&(n=t.getContext("2d"),n.lineWidth=4,n.lineCap="round"),String.prototype.format=function(){var e=arguments;return this.replace(/{(\d+)}/g,(function(t,n){return void 0!==e[n]?e[n]:t}))},function(){const e=window.location.pathname.split("/"),t=e[e.length-1];switch($("body").hide(),t){case"sign.html":if(!window.localStorage.getItem("uploadPdf"))return void(window.location.href="index.html");break;case"finish.html":if(!window.localStorage.getItem("signPdf"))return void(window.location.href="index.html")}$("body").show()}(),$(document).on("mousedown","#signCanvas",d).on("mouseup","#signCanvas",c).on("mouseleave","#signCanvas",c).on("mousemove","#signCanvas",r).on("touchstart","#signCanvas",d).on("touchend","#signCanvas",c).on("touchcancel","#signCanvas",c).on("touchmove","#signCanvas",r).on("click","#btnPrev",(function(e){if(e.preventDefault(),$(".upload_edit_block").is(":visible")||$(".sign_container").length){return void new bootstrap.Modal("#uploadModal",{keyboard:!0}).show()}const t=window.location.pathname.split("/");switch(t[t.length-1]){case"upload.html":window.location.href="index.html";break;case"sign.html":window.location.href="upload.html"}})).on("click","#btnNext",(function(e){e.preventDefault(),window.location.href="sign.html"})).on("click","#btnSignNext",(function(e){e.preventDefault();new bootstrap.Modal("#savePdfModal",{keyboard:!0}).show()})).on("click","#btnBackHome",(function(e){e.preventDefault(),window.localStorage.removeItem("signPdf"),window.location.href="index.html"})).on("click","#btnAdd, #btnAddFile",(function(e){e.preventDefault(),window.location.href="upload.html"})).on("click","#btnBack",(function(e){e.preventDefault(),window.localStorage.removeItem("uploadPdf"),window.localStorage.removeItem("projectName");const t=window.location.pathname.split("/");switch(t[t.length-1]){case"upload.html":window.location.href="index.html";break;case"sign.html":window.location.href="upload.html"}})).on("click","#btnDeleteFile",(function(e){e.preventDefault(),$(".upload_block").show(),$(".upload_edit_block").hide(),window.localStorage.removeItem("uploadPdf"),window.localStorage.removeItem("projectName"),window.location.href="upload.html"})).on("click","#btnColorBlack, #btnColorBlue, #btnColorRed",(function(e){switch(e.preventDefault(),$(this).attr("id")){case"btnColorBlack":n.strokeStyle="black";break;case"btnColorBlue":n.strokeStyle="blue";break;case"btnColorRed":n.strokeStyle="red"}$(".tool_list").find(".ico_box").removeClass("active"),$(this).addClass("active")})).on("click","#btnSignClear",(function(e){e.preventDefault(),n.clearRect(0,0,t.width,t.height),$("#btnSaveSign").addClass("disabled").attr("disabled",!0)})).on("click","#btnCancelSign",(function(e){e.preventDefault(),n.clearRect(0,0,t.width,t.height)})).on("click","#btnSaveSign",(function(e){e.preventDefault();const o=t.toDataURL("image/png"),i=window.localStorage.getItem("signImg");let l=[];i&&(l=JSON.parse(i)),l.unshift(o),window.localStorage.setItem("signImg",JSON.stringify(l)),a.hide(),n.clearRect(0,0,t.width,t.height),s()})).on("click","#btnAddSign",(function(e){e.preventDefault(),a.show()})).on("click","#btnSavePdf",(function(e){e.preventDefault();const t=i.toDataURL("image/png");window.localStorage.setItem("signPdf",t),window.localStorage.removeItem("uploadPdf"),window.localStorage.removeItem("projectName"),window.location.href="finish.html"})).on("click","#btnDownload",(function(e){e.preventDefault();const t=new jsPDF,n=window.localStorage.getItem("signPdf"),o=window.localStorage.getItem("projectName")||"download",a=t.internal.pageSize.width,i=t.internal.pageSize.height;t.addImage(n,"png",0,0,a,i),t.save(`${o}.pdf`)})).on("click",".sign_card",(function(e){e.preventDefault();const t=e.target.src;t&&fabric.Image.fromURL(t,(function(e){e.top=400,e.scaleX=.5,e.scaleY=.5,i.add(e)}))})).on("click",".sign_card .ico_box",(function(e){e.preventDefault();const t=$(this).parent().attr("data-idx"),n=window.localStorage.getItem("signImg");if(n){const e=JSON.parse(n);e.splice(t,1),window.localStorage.setItem("signImg",JSON.stringify(e))}s()})).on("dragover","#dragUpload",(function(e){e.preventDefault(),e.stopPropagation()})).on("dragenter","#dragUpload",(function(e){e.preventDefault(),e.stopPropagation(),$(".upload_block").addClass("active")})).on("dragleave","#dragUpload",(function(e){e.preventDefault(),e.stopPropagation(),$(".upload_block").removeClass("active")})).on("drop","#dragUpload",(async function(e){e.preventDefault(),e.stopPropagation(),p(e.originalEvent.dataTransfer.files[0])})).on("change","#uploadFile",(async function(e){p(e.target.files[0])})).on("change","#inputProjectName",(function(e){window.localStorage.setItem("projectName",e.target.value)})).ready((function(){pdfjsLib.GlobalWorkerOptions.workerSrc="https://mozilla.github.io/pdf.js/build/pdf.worker.js";const e=window.localStorage.getItem("uploadPdf"),t=window.localStorage.getItem("signPdf");e&&(i=new fabric.Canvas("uploadPreviewPdfCanvas"),i.setWidth(612),i.setHeight(729),i.setBackgroundImage(e,i.renderAll.bind(i))),$("#signModal").length&&(a=new bootstrap.Modal("#signModal",{keyboard:!0})),$(".preview_container").length&&($(".preview_container").append(`<img src="${t}" alt="sign_pdf" />`),l("info","檔案建立完成")),$(".upload_block").length||$(".upload_edit_block").length?$("#step1").addClass("active"):$(".sign_container").length?($("#step1").removeClass("active").addClass("complete").find(".step").addClass("active"),$("#step2").addClass("active")):$(".preview_container").length&&($("#step1, #step2").removeClass("active").addClass("complete").find(".step").addClass("active"),$("#step3").addClass("active")),s()})),$(window).on("resize",(function(){}))}));
//# sourceMappingURL=app.js.map
