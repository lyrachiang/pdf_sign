{"version":3,"sources":["assets/js/app.js"],"names":["$","pdfUploadCanvas","fabric","Canvas","signCanvas","ctx","isDraw","signModal","uploadPreviewPdfCanvas","toast","type","msg","find","text","end","addClass","setTimeout","removeClass","showSignImg","localStorageSignImg","window","localStorage","getItem","html","arrSignImg","JSON","parse","signImgTpl","forEach","imgSrc","idx","append","format","length","startDraw","attr","stopDraw","beginPath","onDraw","e","position","canvasSize","getBoundingClientRect","x","clientX","left","y","clientY","top","touches","lineTo","stroke","async","renderPDF","file","blob","Promise","resolve","reject","reader","FileReader","addEventListener","result","readAsDataURL","pdfData","atob","substring","pdfFile","pdfjsLib","getDocument","data","promise","pdfPage","getPage","viewport","getViewport","scale","devicePixelRatio","canvas","document","createElement","context","getContext","height","width","renderContext","canvasContext","_pdfInfo","numPages","render","then","uploadFile","fileData","fileName","name","fileSize","Math","floor","size","projectName","substr","requestRenderAll","pdfImage","Image","id","scaleX","scaleY","transformImage","setWidth","setHeight","setBackgroundImage","renderAll","bind","uploadPdf","toDataURL","setItem","hide","val","css","lineWidth","lineCap","String","prototype","args","arguments","this","replace","match","number","arrPath","location","pathname","split","pageName","href","show","checkStatus","on","preventDefault","is","bootstrap","Modal","keyboard","removeItem","strokeStyle","clearRect","signImg","arrImg","unshift","stringify","pdf","jsPDF","signPdf","internal","pageSize","addImage","save","selectSignImg","target","src","fromURL","img","add","imgIdx","parent","splice","stopPropagation","originalEvent","dataTransfer","files","value","ready","GlobalWorkerOptions","workerSrc"],"mappings":"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","file":"app.js","sourcesContent":["$(function() {\n  const pdfUploadCanvas = new fabric.Canvas('pdfUploadCanvas');\n  const signCanvas = $('#signCanvas')[0];\n  const Base64Prefix = 'data:application/pdf;base64,';\n  const pdfPreviewWidth = 242;\n  const pdfPreviewHeight = 342;\n  \n  let ctx = null;\n  let isDraw = false;\n  let signModal = null;\n  let uploadPreviewPdfCanvas = null;\n\n  if (signCanvas) {\n    ctx = signCanvas.getContext('2d');\n    ctx.lineWidth = 4;\n    ctx.lineCap = 'round';\n  }\n\n  String.prototype.format = function() {\n    var args = arguments;\n    return this.replace(/{(\\d+)}/g, function(match, number) {\n        return typeof args[number] != 'undefined' ? args[number] : match;\n    });\n  } ;\n\n  function toast(type, msg) {\n    $('.toast')\n      .find('.toast-body').text(msg)\n      .end()\n      .addClass('show');\n\n    if (type === 'error') {\n      $('.toast').addClass('error');\n    }\n      \n    setTimeout(() => {\n      $('.toast')\n        .find('.toast-body').text('')\n        .end()\n        .removeClass('error')\n        .removeClass('show');\n    }, 3000);\n  }\n\n  function checkStatus() {\n    const pathname = window.location.pathname;\n    const arrPath = pathname.split('/');\n    const pageName = arrPath[arrPath.length - 1];\n\n    $('body').hide();\n\n    switch(pageName) {\n      case 'sign.html':\n        if (!window.localStorage.getItem('uploadPdf')) {\n          window.location.href = 'index.html';\n          return;\n        }\n      break;\n\n      case 'finish.html':\n        if (!window.localStorage.getItem('signPdf')) {\n          window.location.href = 'index.html';\n          return;\n        }\n      break;\n    }\n\n    $('body').show();\n  }\n\n  function showTimeline() {\n    if ($('.upload_block').length || $('.upload_edit_block').length) {\n      $('#step1').addClass('active');\n    } else if ($('.sign_container').length) {\n      $('#step1')\n        .removeClass('active')\n        .addClass('complete')\n        .find('.step')\n        .addClass('active');\n\n      $('#step2').addClass('active');\n    } else if ($('.preview_container').length) {\n      $('#step1, #step2')\n        .removeClass('active')\n        .addClass('complete')\n        .find('.step')\n        .addClass('active');\n\n      $('#step3').addClass('active');\n    }\n  }\n\n  function showSignImg() {\n    const localStorageSignImg = window.localStorage.getItem('signImg');\n\n    $('.sign_card_box').find('div').html('');\n\n    if (localStorageSignImg) {\n      const arrSignImg = JSON.parse(localStorageSignImg);\n      const signImgTpl = `\n        <div class=\"sign_card\" data-idx=\"{0}\">\n          <a class=\"ico_box\"><span></span></a>\n          <img src=\"{1}\" alt=\"sign_img\" />\n        </div>\n      `;\n\n      arrSignImg.forEach((imgSrc, idx) => {\n        $('.sign_card_box > div').append(signImgTpl.format(idx, imgSrc));\n      });\n\n      if (arrSignImg.length) {\n        $('.sign_container').find('.sign_box').removeClass('no_sign');\n      } else {\n        $('.sign_container').find('.sign_box').addClass('no_sign');\n      }\n    } else {\n      $('.sign_container').find('.sign_box').addClass('no_sign');\n    }\n  }\n\n  function startDraw() {\n    isDraw = true;\n\n    $('#btnSaveSign')\n      .removeClass('disabled')\n      .attr('disabled', false);\n  }\n\n  function stopDraw() {\n    isDraw = false;\n    ctx.beginPath();\n  }\n\n  function onDraw(e) {\n    if (!isDraw) {\n      return;\n    }\n\n    let position;\n    const canvasSize = signCanvas.getBoundingClientRect();\n\n    if (e.type === 'mousemove') {\n      position = {\n        x: e.clientX - canvasSize.left,\n        y: e.clientY - canvasSize.top,\n      };\n    } else {\n      position = {\n        x: e.touches[0].clientX - canvasSize.left,\n        y: e.touches[0].clientY - canvasSize.top,\n      };\n    }\n\n    ctx.lineTo(position.x, position.y);\n    ctx.stroke();\n  }\n\n  function transformFile(blob) {\n    return new Promise((resolve, reject) => {\n      const reader = new FileReader();\n      reader.addEventListener('load', () => resolve(reader.result));\n      reader.addEventListener('error', reject);\n      reader.readAsDataURL(blob);\n    });\n  }\n\n  async function renderPDF(file) {\n    file = await transformFile(file);\n\n    const pdfData = atob(file.substring(Base64Prefix.length));\n    const pdfFile = await pdfjsLib.getDocument({ data: pdfData }).promise;\n    const pdfPage = await pdfFile.getPage(1);\n\n    const viewport = pdfPage.getViewport({ scale: window.devicePixelRatio });\n    const canvas = document.createElement('canvas');\n    const context = canvas.getContext('2d');\n\n    canvas.height = viewport.height;\n    canvas.width = viewport.width;\n\n    const renderContext = {\n      canvasContext: context,\n      viewport,\n    };\n\n    $('#uploadFilePage').text(`${pdfFile._pdfInfo.numPages}頁`);\n\n    return pdfPage.render(renderContext).promise\n            .then(() => canvas);\n  }\n\n  async function transformImage(file) {\n    const scale = 1 / window.devicePixelRatio;\n\n    return new fabric.Image(file, {\n      id: 'pdfImg',\n      scaleX: scale,\n      scaleY: scale,\n    });\n  }\n\n  async function uploadFile(fileData) {\n    const fileName = fileData.name;\n    const fileSize = Math.floor(fileData.size * 0.001);\n    const projectName = fileName.substr(0, fileName.length - 4);\n\n    if (fileSize > 1024*1024*20) {\n      toast('error', '檔案大小超過20MB');\n      return;\n    }\n\n    pdfUploadCanvas.requestRenderAll();\n\n    const pdfData = await renderPDF(fileData);\n    const pdfImage = await transformImage(pdfData);\n\n    pdfUploadCanvas.setWidth(pdfImage.width / window.devicePixelRatio);\n    pdfUploadCanvas.setHeight(pdfImage.height / window.devicePixelRatio);\n    pdfUploadCanvas.setBackgroundImage(pdfImage, pdfUploadCanvas.renderAll.bind(pdfUploadCanvas));\n\n    const uploadPdf = pdfUploadCanvas.toDataURL('image/png');\n    window.localStorage.setItem('uploadPdf', uploadPdf);\n\n    pdfUploadCanvas.setWidth(pdfPreviewWidth);\n    pdfUploadCanvas.setHeight(pdfPreviewHeight);\n    pdfUploadCanvas.setBackgroundImage(pdfImage, pdfUploadCanvas.renderAll.bind(pdfUploadCanvas),{\n      scaleX: pdfUploadCanvas.width / pdfImage.width,\n      scaleY: pdfUploadCanvas.height / pdfImage.height\n    });\n    \n    $('.upload_block').hide();\n    $('#uploadFileName').text(fileName);\n    $('#inputProjectName').val(projectName);\n    $('.upload_edit_block').css('display', 'flex');\n    $('#btnNext')\n      .removeClass('disabled')\n      .attr('disabled', false);\n\n    toast('info', '檔案上傳成功');\n\n    window.localStorage.setItem('projectName', projectName);\n  }\n\n  checkStatus();\n\n  $(document)\n    .on('mousedown', '#signCanvas', startDraw)\n    .on('mouseup', '#signCanvas', stopDraw)\n    .on('mouseleave', '#signCanvas', stopDraw)\n    .on('mousemove', '#signCanvas', onDraw)\n    .on('touchstart', '#signCanvas', startDraw)\n    .on('touchend', '#signCanvas', stopDraw)\n    .on('touchcancel', '#signCanvas', stopDraw)\n    .on('touchmove', '#signCanvas', onDraw)\n    .on('click', '#btnPrev', function(e) {\n      e.preventDefault();\n\n      if ($('.upload_edit_block').is(':visible') || $('.sign_container').length) {\n        const uploadModal = new bootstrap.Modal('#uploadModal', {\n          keyboard: true\n        });\n  \n        uploadModal.show();\n        return;\n      }\n\n      const pathname = window.location.pathname;\n      const arrPath = pathname.split('/');\n      const pageName = arrPath[arrPath.length - 1];\n\n      switch(pageName) {\n        case 'upload.html':\n          window.location.href = 'index.html';\n        break;\n\n        case 'sign.html':\n          window.location.href = 'upload.html';\n        break;\n      }\n    })\n    .on('click', '#btnNext', function(e) {\n      e.preventDefault();\n      window.location.href = 'sign.html';\n    })\n    .on('click', '#btnSignNext', function(e) {\n      e.preventDefault();\n\n      const savePdfModal = new bootstrap.Modal('#savePdfModal', {\n        keyboard: true\n      });\n\n      savePdfModal.show();\n    })\n    .on('click', '#btnBackHome', function(e) {\n      e.preventDefault();\n      window.localStorage.removeItem('signPdf');\n      window.location.href = 'index.html';\n    })\n    .on('click', '#btnAdd, #btnAddFile', function(e) {\n      e.preventDefault();\n      window.location.href = 'upload.html';\n    })\n    .on('click', '#btnBack', function(e) {\n      e.preventDefault();\n\n      window.localStorage.removeItem('uploadPdf');\n      window.localStorage.removeItem('projectName');\n\n      const pathname = window.location.pathname;\n      const arrPath = pathname.split('/');\n      const pageName = arrPath[arrPath.length - 1];\n\n      switch(pageName) {\n        case 'upload.html':\n          window.location.href = 'index.html';\n        break;\n\n        case 'sign.html':\n          window.location.href = 'upload.html';\n        break;\n      }\n    })\n    .on('click', '#btnDeleteFile', function(e) {\n      e.preventDefault();\n      \n      $('.upload_block').show();\n      $('.upload_edit_block').hide();\n\n      window.localStorage.removeItem('uploadPdf');\n      window.localStorage.removeItem('projectName');\n      window.location.href = 'upload.html';\n    })\n    .on('click', '#btnColorBlack, #btnColorBlue, #btnColorRed', function(e) {\n      e.preventDefault();\n      \n      switch($(this).attr('id')) {\n        case 'btnColorBlack':\n          ctx.strokeStyle = 'black';\n        break;\n\n        case 'btnColorBlue':\n          ctx.strokeStyle = 'blue';\n        break;\n\n        case 'btnColorRed':\n          ctx.strokeStyle = 'red';\n        break;\n      }\n      \n      $('.tool_list').find('.ico_box').removeClass('active');\n      $(this).addClass('active');\n    })\n    .on('click', '#btnSignClear', function(e) {\n      e.preventDefault();\n      \n      ctx.clearRect(0, 0, signCanvas.width, signCanvas.height);\n\n      $('#btnSaveSign')\n        .addClass('disabled')\n        .attr('disabled', true);\n    })\n    .on('click', '#btnCancelSign', function(e) {\n      e.preventDefault();\n      ctx.clearRect(0, 0, signCanvas.width, signCanvas.height);\n    })\n    .on('click', '#btnSaveSign', function(e) {\n      e.preventDefault();\n      \n      const signImg = signCanvas.toDataURL('image/png');\n      const localStorageSignImg = window.localStorage.getItem('signImg');\n      let arrImg = [];\n\n      if (localStorageSignImg) {\n        arrImg = JSON.parse(localStorageSignImg);\n      }\n\n      arrImg.unshift(signImg);\n\n      window.localStorage.setItem('signImg', JSON.stringify(arrImg));\n      signModal.hide();\n      ctx.clearRect(0, 0, signCanvas.width, signCanvas.height);\n      showSignImg();\n    })\n    .on('click', '#btnAddSign', function(e) {\n      e.preventDefault();\n      signModal.show();\n    })\n    .on('click', '#btnSavePdf', function(e) {\n      e.preventDefault();\n      const imgSrc = uploadPreviewPdfCanvas.toDataURL('image/png');\n      window.localStorage.setItem('signPdf', imgSrc);\n\n      window.localStorage.removeItem('uploadPdf');\n\n      window.location.href = 'finish.html';\n    })\n    .on('click', '#btnDownload', function(e) {\n      e.preventDefault();\n      const pdf = new jsPDF();\n      const signPdf = window.localStorage.getItem('signPdf');\n      const projectName = window.localStorage.getItem('projectName') || 'download';\n      const width = pdf.internal.pageSize.width;\n      const height = pdf.internal.pageSize.height;\n\n      pdf.addImage(signPdf, 'png', 0, 0, width, height);\n      pdf.save(`${projectName}.pdf`);\n    })\n    .on('click', '.sign_card', function(e) {\n      e.preventDefault();\n\n      const selectSignImg = e.target.src;\n\n      if (!selectSignImg) {\n        return;\n      }\n\n      fabric.Image.fromURL(selectSignImg, function (img) {\n        img.top = 400;\n        img.scaleX = 0.5;\n        img.scaleY = 0.5;\n        uploadPreviewPdfCanvas.add(img);\n      });\n    })\n    .on('click', '.sign_card .ico_box', function(e) {\n      e.preventDefault();\n\n      const imgIdx = $(this).parent().attr('data-idx');\n      const localStorageSignImg = window.localStorage.getItem('signImg');\n\n      if (localStorageSignImg) {\n        const arrSignImg = JSON.parse(localStorageSignImg);\n        arrSignImg.splice(imgIdx, 1);\n\n        window.localStorage.setItem('signImg', JSON.stringify(arrSignImg))\n      }\n\n      showSignImg();\n    })\n    .on('dragover', '#dragUpload', function(e) {\n      e.preventDefault();\n      e.stopPropagation();\n    })\n    .on('dragenter', '#dragUpload', function(e) {\n      e.preventDefault();\n      e.stopPropagation();\n\n      $('.upload_block').addClass('active');\n    })\n    .on('dragleave', '#dragUpload', function(e) {\n      e.preventDefault();\n      e.stopPropagation();\n\n      $('.upload_block').removeClass('active');\n    })\n    .on('drop', '#dragUpload', async function(e) {\n      e.preventDefault();\n      e.stopPropagation();\n\n      uploadFile(e.originalEvent.dataTransfer.files[0]);\n    })\n    .on('change', '#uploadFile', async function(e) {\n      uploadFile(e.target.files[0]);\n    })\n    .on('change', '#inputProjectName', function(e) {\n      window.localStorage.setItem('projectName', e.target.value);\n    })\n    .ready(function() {\n      pdfjsLib.GlobalWorkerOptions.workerSrc = \"https://mozilla.github.io/pdf.js/build/pdf.worker.js\";\n\n      const uploadPdf = window.localStorage.getItem('uploadPdf');\n      const signPdf = window.localStorage.getItem('signPdf');\n\n      if (uploadPdf) {\n        uploadPreviewPdfCanvas = new fabric.Canvas('uploadPreviewPdfCanvas');\n        uploadPreviewPdfCanvas.setWidth(612);\n        uploadPreviewPdfCanvas.setHeight(729);\n        uploadPreviewPdfCanvas.setBackgroundImage(uploadPdf, uploadPreviewPdfCanvas.renderAll.bind(uploadPreviewPdfCanvas));\n      }\n\n      if ($('#signModal').length) {\n        signModal = new bootstrap.Modal('#signModal', {\n          keyboard: true\n        });\n      }\n\n      if ($('.preview_container').length) {\n        $('.preview_container').append(`<img src=\"${signPdf}\" alt=\"sign_pdf\" />`);\n\n        toast('info', '檔案建立完成');\n      }\n\n      showTimeline();\n      showSignImg();\n    });\n  \n  $(window)\n    .on('resize', function() {\n\n    });\n});"]}